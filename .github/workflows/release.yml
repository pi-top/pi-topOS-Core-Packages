name: Release (Bullseye)

on:
  workflow_dispatch:
    branches:
      - bullseye

env:
  REPO: "experimental"
  OS_TYPE: "debian"
  OS_VERSION: "bullseye"

jobs:
  release:
    runs-on: ubuntu-20.04
    steps:
      - name: GitHub Environment Variables Action
        uses: FranzDiebold/github-env-vars-action@v1.2.1

      - name: Checkout code
        uses: actions/checkout@v2.2.0

      - name: Determine version
        run: |
          sudo apt install -y dpkg-dev
          echo "VERSION=$(dpkg-parsechangelog -Sversion)" >> $GITHUB_ENV
          rm -rf ./*

      - name: Download artifact
        uses: dawidd6/action-download-artifact@v2.14.0
        with:
          workflow: build.yml

      - name: Organise artifact files
        run: |
          mkdir deb
          mv ${{ env.GITHUB_REPOSITORY_NAME }}*/* deb
          rm -rf ${{ env.GITHUB_REPOSITORY_NAME }}*

      # Not releasing on GitHub until versions are final
      #
      # - name: Create Release
      #   uses: softprops/action-gh-release@v1
      #   with:
      #     tag_name: "v${{ env.VERSION }}"
      #     name: "v${{ env.VERSION }}"
      #     draft: false
      #     prerelease: false
      #     files: ./deb/*
      #   env:
      #     GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Install PackageCloud CLI
        run: |
          sudo gem install package_cloud

      - name: Publish Debian package(s)
        run: |
          PACKAGECLOUD_TOKEN=${{ secrets.PACKAGECLOUD_TOKEN }} \
            package_cloud \
              push --verbose \
              pi-top/${{ env.REPO }}/${{ env.OS_TYPE }}/${{ env.OS_VERSION }} \
              ./deb/*.dsc
